/*******************************************************************************
 * Copyright (C) 2016 Black Duck Software, Inc.
 * http://www.blackducksoftware.com/
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *******************************************************************************/
package com.blackducksoftware.integration.jira.task.conversion;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

import java.io.IOException;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;
import org.mockito.Mockito;

import com.atlassian.jira.project.ProjectManager;
import com.blackducksoftware.integration.hub.HubIntRestService;
import com.blackducksoftware.integration.hub.api.notification.VulnerabilitySourceQualifiedId;
import com.blackducksoftware.integration.hub.api.project.ProjectVersion;
import com.blackducksoftware.integration.hub.api.version.ReleaseItem;
import com.blackducksoftware.integration.hub.api.vulnerableBomComponent.VulnerableBomComponentItem;
import com.blackducksoftware.integration.hub.api.vulnerableBomComponent.VulnerableBomComponentRestService;
import com.blackducksoftware.integration.hub.dataservices.notification.items.NotificationContentItem;
import com.blackducksoftware.integration.hub.dataservices.notification.items.VulnerabilityContentItem;
import com.blackducksoftware.integration.hub.exception.BDRestException;
import com.blackducksoftware.integration.hub.exception.NotificationServiceException;
import com.blackducksoftware.integration.hub.exception.UnexpectedHubResponseException;
import com.blackducksoftware.integration.hub.meta.MetaInformation;
import com.blackducksoftware.integration.hub.meta.MetaLink;
import com.blackducksoftware.integration.jira.common.HubProject;
import com.blackducksoftware.integration.jira.common.HubProjectMapping;
import com.blackducksoftware.integration.jira.common.HubProjectMappings;
import com.blackducksoftware.integration.jira.common.JiraContext;
import com.blackducksoftware.integration.jira.common.JiraProject;
import com.blackducksoftware.integration.jira.common.exception.ConfigurationException;
import com.blackducksoftware.integration.jira.mocks.ApplicationUserMock;
import com.blackducksoftware.integration.jira.mocks.PluginSettingsMock;
import com.blackducksoftware.integration.jira.mocks.ProjectManagerMock;
import com.blackducksoftware.integration.jira.task.JiraSettingsService;
import com.blackducksoftware.integration.jira.task.conversion.output.HubEvent;
import com.blackducksoftware.integration.jira.task.issue.JiraServices;

public class VulnerabilityNotificationConverterTest {
	private static final String COMPONENT_NAME = "componentName";
	private static final String PROJECT_VERSION_URL = "http://eng-hub-valid03.dc1.lan/api/projects/a3b48f57-9c00-453f-8672-804e08c317f2/versions/7d4fdbed-936b-468f-af7f-826dfc072c5b";
	private static final String COMPONENT_VERSION_URL = "http://eng-hub-valid03.dc1.lan/api/components/0934ea45-c739-4b58-bcb1-ee777022ce4f/versions/7c45d411-92ca-45b0-80fc-76b765b954ef";
	private static final String SAMPLE_VULN = "CVE-2016-0006";
	private static final String TEST_PROJECT_VERSION = "testVersionName";
	private static final String HUB_COMPONENT_NAME = "test Hub Component";
	private static final String HUB_PROJECT_NAME = "test Hub Project";
	private static final String PROJECT_URL = "http://test.project.url";
	private static final String COMPONENT_VERSION_NAME = "versionName";
	private static final String PROJECTVERSION_URL = PROJECT_VERSION_URL;

	@BeforeClass
	public static void setUpBeforeClass() throws Exception {
	}

	@AfterClass
	public static void tearDownAfterClass() throws Exception {
	}

	@Test
	public void test() throws NotificationServiceException, UnexpectedHubResponseException, ConfigurationException,
	URISyntaxException, IOException, BDRestException {
		final List<HubEvent> events = generateEvents(true, true);

		assertEquals(1, events.size());

		System.out.println(events.get(0));
		assertTrue(events.get(0).getIssueSummary().contains(HUB_PROJECT_NAME));
		assertTrue(events.get(0).getIssueSummary().contains(TEST_PROJECT_VERSION));
		assertTrue(events.get(0).getIssueSummary().contains(HUB_COMPONENT_NAME));
		assertTrue(events.get(0).getIssueSummary().contains(COMPONENT_VERSION_NAME));

		assertTrue(events.get(0).getIssueSummary().contains(HUB_PROJECT_NAME));
		assertTrue(events.get(0).getIssueSummary().contains(TEST_PROJECT_VERSION));
		assertTrue(events.get(0).getIssueSummary().contains(HUB_COMPONENT_NAME));
		assertTrue(events.get(0).getIssueSummary().contains(COMPONENT_VERSION_NAME));

		System.out.println(events.get(0).getComment());
		assertTrue(events.get(0).getComment().contains(SAMPLE_VULN));
	}

	@Test
	public void testNoProjectMappingMatch()
			throws NotificationServiceException, UnexpectedHubResponseException,
			ConfigurationException, URISyntaxException, IOException, BDRestException {
		final List<HubEvent> events = generateEvents(true, false);
		assertEquals(0, events.size());
	}

	@Test
	public void testWithoutMappings()
			throws NotificationServiceException, UnexpectedHubResponseException,
			ConfigurationException, URISyntaxException, IOException, BDRestException {
		final List<HubEvent> events = generateEvents(false, false);

		assertEquals(0, events.size());
	}

	private List<HubEvent> generateEvents(final boolean includeProjectMappings, final boolean projectMappingMatch)
			throws NotificationServiceException, UnexpectedHubResponseException, ConfigurationException,
			URISyntaxException, IOException, BDRestException {

		final ApplicationUserMock jiraUser = new ApplicationUserMock();

		final JiraContext jiraContext = new JiraContext(jiraUser);

		final JiraServices jiraServices = ConverterTestUtils.mockJiraServices();
		final HubProjectMappings mappings = new HubProjectMappings(jiraServices, jiraContext,
				createProjectMappings(includeProjectMappings, projectMappingMatch));

		final NotificationContentItem notification = createNotification();

		final JiraSettingsService jiraSettingsService = new JiraSettingsService(new PluginSettingsMock());
		final HubIntRestService hubIntRestService = Mockito.mock(HubIntRestService.class);
		//
		final ReleaseItem projectReleaseItem = Mockito.mock(ReleaseItem.class);
		Mockito.when(projectReleaseItem.getLink("vulnerable-components")).thenReturn("vulnerableComponentsUrl");
		Mockito.when(
				hubIntRestService
				.getProjectVersion(PROJECT_VERSION_URL))
				.thenReturn(projectReleaseItem);

		final List<VulnerableBomComponentItem> vulnerableBomComponentItems = new ArrayList<>();
		final List<MetaLink> links = new ArrayList<>();
		final MetaLink metaLink = new MetaLink("vulnerable-components", "vulncompsurl");
		links.add(metaLink);
		final MetaInformation meta = new MetaInformation(new ArrayList<String>(), "href", links);
		final VulnerableBomComponentItem vulnerableBomComponentItem = new VulnerableBomComponentItem(meta,
				COMPONENT_NAME, "componentVersionName", "componentVersionLink", null);
		vulnerableBomComponentItems.add(vulnerableBomComponentItem);

		final VulnerableBomComponentRestService vulnerableBomComponentRestService = Mockito
				.mock(VulnerableBomComponentRestService.class);
		Mockito.when(
				vulnerableBomComponentRestService.getVulnerableComponentsMatchingComponentName(PROJECT_VERSION_URL,
						COMPONENT_NAME)).thenReturn(vulnerableBomComponentItems);
		final NotificationToEventConverter converter = new VulnerabilityNotificationConverter(mappings, jiraServices,
				jiraContext, jiraSettingsService, hubIntRestService, vulnerableBomComponentRestService);
		final List<HubEvent> events = converter.generateEvents(notification);
		return events;
	}

	private NotificationContentItem createNotification() throws URISyntaxException {

		final List<VulnerabilitySourceQualifiedId> deletedVulnerabilityIds = new ArrayList<>();
		deletedVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", "CVE-2016-0001"));
		deletedVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", "CVE-2016-0002"));

		final List<VulnerabilitySourceQualifiedId> newVulnerabilityIds = new ArrayList<>();
		newVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", "CVE-2016-0003"));
		newVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", "CVE-2016-0004"));

		final List<VulnerabilitySourceQualifiedId> updatedVulnerabilityIds = new ArrayList<>();
		updatedVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", "CVE-2016-0005"));
		updatedVulnerabilityIds.add(new VulnerabilitySourceQualifiedId("NVD", SAMPLE_VULN));

		final ProjectVersion projectVersion = new ProjectVersion();
		projectVersion.setProjectName(HUB_PROJECT_NAME);
		projectVersion.setUrl(PROJECTVERSION_URL);
		projectVersion.setProjectVersionName(TEST_PROJECT_VERSION);

		final VulnerabilityContentItem notif = new VulnerabilityContentItem(new Date(), projectVersion,
				HUB_COMPONENT_NAME,
				COMPONENT_VERSION_NAME, COMPONENT_VERSION_URL, newVulnerabilityIds,
				updatedVulnerabilityIds,
				deletedVulnerabilityIds);

		return notif;
	}

	private Set<HubProjectMapping> createProjectMappings(final boolean includeMapping, final boolean includeMatch) {

		final Set<HubProjectMapping> mappings = new HashSet<>();

		if (includeMapping) {
			String suffix;
			if (includeMatch) {
				suffix = "";
			} else {
				suffix = "XX";
			}

			final HubProjectMapping mapping = new HubProjectMapping();
			final HubProject hubProject = new HubProject();
			hubProject.setProjectName(HUB_PROJECT_NAME + suffix);
			hubProject.setProjectUrl(PROJECT_URL);
			mapping.setHubProject(hubProject);
			final JiraProject jiraProject = new JiraProject();
			jiraProject.setProjectId(ProjectManagerMock.JIRA_PROJECT_ID_BASE);
			jiraProject.setProjectName(ProjectManagerMock.JIRA_PROJECT_PREFIX);
			mapping.setJiraProject(jiraProject);

			System.out.println("Mapping: " + mapping);
			mappings.add(mapping);
		}
		return mappings;
	}

	private ProjectManager createJiraProjectManager() {
		final ProjectManagerMock projectManager = new ProjectManagerMock();
		projectManager.setProjectObjects(ProjectManagerMock.getTestProjectObjectsWithTaskIssueType());
		return projectManager;
	}

}