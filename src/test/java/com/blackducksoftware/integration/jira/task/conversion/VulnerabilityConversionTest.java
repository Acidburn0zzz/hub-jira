/*
 * Copyright (C) 2016 Black Duck Software Inc.
 * http://www.blackducksoftware.com/
 * All rights reserved.
 * 
 * This software is the confidential and proprietary information of
 * Black Duck Software ("Confidential Information"). You shall not
 * disclose such Confidential Information and shall use it only in
 * accordance with the terms of the license agreement you entered into
 * with Black Duck Software.
 */
package com.blackducksoftware.integration.jira.task.conversion;

import static org.junit.Assert.assertEquals;

import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;
import org.mockito.Mockito;

import com.atlassian.jira.config.ConstantsManager;
import com.atlassian.jira.issue.issuetype.IssueType;
import com.atlassian.jira.user.ApplicationUser;
import com.blackducksoftware.integration.hub.api.item.MetaService;
import com.blackducksoftware.integration.hub.api.notification.VulnerabilitySourceQualifiedId;
import com.blackducksoftware.integration.hub.api.project.ProjectVersion;
import com.blackducksoftware.integration.hub.api.vulnerablebomcomponent.VulnerableBomComponentRequestService;
import com.blackducksoftware.integration.hub.dataservice.notification.item.NotificationContentItem;
import com.blackducksoftware.integration.hub.dataservice.notification.item.VulnerabilityContentItem;
import com.blackducksoftware.integration.hub.exception.HubIntegrationException;
import com.blackducksoftware.integration.hub.service.HubRequestService;
import com.blackducksoftware.integration.hub.service.HubServicesFactory;
import com.blackducksoftware.integration.jira.common.HubProject;
import com.blackducksoftware.integration.jira.common.HubProjectMapping;
import com.blackducksoftware.integration.jira.common.HubProjectMappings;
import com.blackducksoftware.integration.jira.common.JiraContext;
import com.blackducksoftware.integration.jira.common.JiraProject;
import com.blackducksoftware.integration.jira.common.exception.ConfigurationException;
import com.blackducksoftware.integration.jira.config.HubJiraFieldCopyConfigSerializable;
import com.blackducksoftware.integration.jira.config.ProjectFieldCopyMapping;
import com.blackducksoftware.integration.jira.task.JiraSettingsService;
import com.blackducksoftware.integration.jira.task.conversion.output.HubEvent;
import com.blackducksoftware.integration.jira.task.conversion.output.HubEventAction;
import com.blackducksoftware.integration.jira.task.issue.JiraServices;

public class VulnerabilityConversionTest {
    private static final String EXPECTED_RESOLVED_COMMENT = "Automatically resolved; the Black Duck Hub reports no remaining vulnerabilities on this project from this component";

    private static final String EXPECTED_REOPEN_COMMENT = "Automatically re-opened in response to new Black Duck Hub vulnerabilities on this project from this component";

    private final static String EXPECTED_COMMENT = "(Black Duck Hub JIRA plugin-generated comment)\n" +
            "Vulnerabilities added: http://int-hub01.dc1.lan:8080/api/components/componentId/versions/versionId (NVD)\n" +
            "Vulnerabilities updated: None\n" +
            "Vulnerabilities deleted: None\n";

    private final static String EXPECTED_DESCRIPTION = "This issue tracks vulnerability status changes on " +
            "Hub project 'hubProjectName' / 'projectVersionName', component 'componentName' / 'componentVersion'. " +
            "For details, see the comments below, or the project's vulnerabilities view in the Hub:\n" +
            "<error getting vulnerable components URL>";

    private final static String EXPECTED_SUMMARY = "Black Duck vulnerability status changes on Hub project " +
            "'hubProjectName' / 'projectVersionName', component 'componentName' / 'componentVersion'";

    @BeforeClass
    public static void setUpBeforeClass() throws Exception {
    }

    @AfterClass
    public static void tearDownAfterClass() throws Exception {
    }

    @Test
    public void test() throws ConfigurationException, HubIntegrationException, URISyntaxException {
        final JiraServices jiraServices = Mockito.mock(JiraServices.class);
        final Set<HubProjectMapping> mappings = new HashSet<>();
        HubProjectMapping mapping = new HubProjectMapping();
        HubProject hubProject = new HubProject();
        hubProject.setProjectName("hubProjectName");
        hubProject.setProjectUrl("hubProjectUrl");
        mapping.setHubProject(hubProject);
        JiraProject jiraProject = new JiraProject();
        jiraProject.setProjectName("jiraProjectName");
        jiraProject.setProjectId(123L);
        jiraProject.setAssigneeUserId("assigneeUserId");
        mapping.setJiraProject(jiraProject);
        mappings.add(mapping);
        final HubProjectMappings mappingObject = new HubProjectMappings(jiraServices,
                mappings);
        final HubJiraFieldCopyConfigSerializable fieldCopyConfig = new HubJiraFieldCopyConfigSerializable();
        Set<ProjectFieldCopyMapping> projectFieldCopyMappings = new HashSet<>();
        fieldCopyConfig.setProjectFieldCopyMappings(projectFieldCopyMappings);

        ConstantsManager constantsManager = Mockito.mock(ConstantsManager.class);
        List<IssueType> issueTypes = new ArrayList<>();
        IssueType issueType = Mockito.mock(IssueType.class);
        Mockito.when(issueType.getName()).thenReturn("Hub Security Vulnerability");
        Mockito.when(issueType.getId()).thenReturn("Hub Security Vulnerability ID");
        issueTypes.add(issueType);
        Mockito.when(constantsManager.getAllIssueTypeObjects()).thenReturn(issueTypes);
        Mockito.when(jiraServices.getConstantsManager()).thenReturn(constantsManager);
        Mockito.when(jiraServices.getJiraProject(123L)).thenReturn(jiraProject);

        ApplicationUser jiraUser = Mockito.mock(ApplicationUser.class);
        Mockito.when(jiraUser.getName()).thenReturn("jiraUserName");
        Mockito.when(jiraUser.getKey()).thenReturn("jiraUserKey");
        final JiraContext jiraContext = new JiraContext(jiraUser);
        final JiraSettingsService jiraSettingsService = null;
        final HubServicesFactory hubServicesFactory = Mockito.mock(HubServicesFactory.class);
        VulnerableBomComponentRequestService vulnBomCompReqSvc = Mockito.mock(VulnerableBomComponentRequestService.class);
        HubRequestService hubRequestService = Mockito.mock(HubRequestService.class);
        Mockito.when(hubServicesFactory.createHubRequestService()).thenReturn(hubRequestService);
        Mockito.when(hubServicesFactory.createVulnerableBomComponentRequestService()).thenReturn(vulnBomCompReqSvc);
        final MetaService metaService = null;

        VulnerabilityNotificationConverter conv = new VulnerabilityNotificationConverter(
                mappingObject,
                fieldCopyConfig,
                jiraServices,
                jiraContext, jiraSettingsService,
                hubServicesFactory, metaService);

        Date now = new Date();
        final Date createdAt = now;
        final ProjectVersion projectVersion = new ProjectVersion();
        projectVersion.setProjectName("hubProjectName");
        projectVersion.setProjectVersionName("projectVersionName");
        projectVersion.setUrl("http://int-hub01.dc1.lan:8080/api/projects/projectId/versions/versionId");
        final String componentName = "componentName";
        final String componentVersion = "componentVersion";
        final String componentVersionUrl = "http://int-hub01.dc1.lan:8080/api/components/componentId/versions/versionId";

        VulnerabilitySourceQualifiedId vuln = new VulnerabilitySourceQualifiedId("NVD", componentVersionUrl);
        final List<VulnerabilitySourceQualifiedId> addedVulnList = new ArrayList<>();
        final List<VulnerabilitySourceQualifiedId> updatedVulnList = new ArrayList<>();
        final List<VulnerabilitySourceQualifiedId> deletedVulnList = new ArrayList<>();
        addedVulnList.add(vuln);
        NotificationContentItem notif = new VulnerabilityContentItem(createdAt, projectVersion,
                componentName,
                componentVersion,
                componentVersionUrl,
                addedVulnList,
                updatedVulnList,
                deletedVulnList);
        List<HubEvent> events = conv.generateEvents(notif);

        assertEquals(1, events.size());
        HubEvent<VulnerabilityContentItem> event = events.get(0);
        assertEquals(HubEventAction.ADD_COMMENT, event.getAction());
        assertEquals(EXPECTED_COMMENT, event.getComment());
        assertEquals(EXPECTED_COMMENT, event.getCommentIfExists());
        assertEquals(EXPECTED_COMMENT, event.getCommentInLieuOfStateChange());
        assertEquals("assigneeUserId", event.getIssueAssigneeId());
        assertEquals(EXPECTED_DESCRIPTION, event.getIssueDescription());
        assertEquals(EXPECTED_SUMMARY, event.getIssueSummary());
        assertEquals("Hub Security Vulnerability ID", event.getJiraIssueTypeId());

        assertEquals(Long.valueOf(123L), event.getJiraProjectId());
        assertEquals("jiraProjectName", event.getJiraProjectName());
        assertEquals("jiraUserKey", event.getJiraUserId());
        assertEquals("jiraUserName", event.getJiraUserName());
        VulnerabilityContentItem vulnContentItem = event.getNotif();
        assertEquals("NVD", vulnContentItem.getAddedVulnList().get(0).getSource());
        assertEquals(0, event.getProjectFieldCopyMappings().size());
        assertEquals(EXPECTED_REOPEN_COMMENT, event.getReopenComment());
        assertEquals(EXPECTED_RESOLVED_COMMENT, event.getResolveComment());
        assertEquals("t=v|jp=123|hpv=-32224582|hc=|hcv=1816144506", event.getUniquePropertyKey());
    }

}
