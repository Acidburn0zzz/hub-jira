package com.blackducksoftware.integration.jira.hub.vulnerability;

import java.util.List;
import java.util.UUID;

import org.apache.log4j.Logger;

import com.blackducksoftware.integration.hub.exception.MissingUUIDException;
import com.blackducksoftware.integration.hub.exception.UnexpectedHubResponseException;
import com.blackducksoftware.integration.hub.version.api.ReleaseItem;
import com.blackducksoftware.integration.jira.HubJiraLogger;
import com.blackducksoftware.integration.jira.config.HubProjectMappings;
import com.blackducksoftware.integration.jira.config.JiraProject;
import com.blackducksoftware.integration.jira.hub.HubEvent;
import com.blackducksoftware.integration.jira.hub.HubEvents;
import com.blackducksoftware.integration.jira.hub.HubNotificationService;
import com.blackducksoftware.integration.jira.hub.HubNotificationServiceException;
import com.blackducksoftware.integration.jira.hub.NotificationToEventConverter;
import com.blackducksoftware.integration.jira.hub.TicketGeneratorInfo;
import com.blackducksoftware.integration.jira.hub.VulnerabilityEvent;
import com.blackducksoftware.integration.jira.hub.model.component.ComponentVersion;
import com.blackducksoftware.integration.jira.hub.model.component.ComponentVersionStatus;
import com.blackducksoftware.integration.jira.hub.model.notification.NotificationItem;
import com.blackducksoftware.integration.jira.hub.model.notification.VulnerabilityNotificationContent;
import com.blackducksoftware.integration.jira.hub.model.notification.VulnerabilityNotificationItem;
import com.blackducksoftware.integration.jira.hub.model.notification.VulnerabilitySourceQualifiedId;
import com.blackducksoftware.integration.jira.hub.model.project.ProjectVersion;
import com.blackducksoftware.integration.jira.issue.HubEventType;

public class VulnerabilityNotificationConverter extends NotificationToEventConverter {
	private final HubJiraLogger logger = new HubJiraLogger(Logger.getLogger(this.getClass().getName()));
	public static final String PROJECT_LINK = "project";
	private final HubProjectMappings mappings;

	private final List<String> linksOfRulesToMonitor;
	private final HubNotificationService hubNotificationService;


	public VulnerabilityNotificationConverter(final HubProjectMappings mappings,
			final TicketGeneratorInfo ticketGenInfo, final List<String> linksOfRulesToMonitor,
			final HubNotificationService hubNotificationService) {
		super(hubNotificationService, ticketGenInfo);
		this.mappings = mappings;
		this.linksOfRulesToMonitor = linksOfRulesToMonitor;
		this.hubNotificationService = hubNotificationService;
	}

	@Override
	public HubEvents generateEvents(final NotificationItem notif) {
		final HubEvents allEvents = new HubEvents();
		final VulnerabilityNotificationItem vulnerabilityNotif = (VulnerabilityNotificationItem) notif;
		logger.debug("vulnerabilityNotif: " + vulnerabilityNotif);
		logger.info("This vulnerability notification affects "
				+ vulnerabilityNotif.getContent().getAffectedProjectVersions().size() + " project versions");
		final VulnerabilityNotificationContent vulnerabilityNotificationContent = vulnerabilityNotif.getContent();

		final String componentName = vulnerabilityNotif.getContent().getComponentName();
		final String componentVersionName = vulnerabilityNotif.getContent().getVersionName();
		final HubEventType eventType;
		String projectName;
		String projectVersionName;
		final List<ComponentVersionStatus> compVerStatuses;
		ReleaseItem notifHubProjectReleaseItem;
		for (final ProjectVersion projectVersion : vulnerabilityNotif.getContent().getAffectedProjectVersions()) {
			projectName = projectVersion.getProjectName();
			projectVersionName = projectVersion.getProjectVersionName();
			final String projectVersionLink = projectVersion.getProjectVersionLink();

			try {
				notifHubProjectReleaseItem = getHubNotificationService().getProjectReleaseItemFromProjectReleaseUrl(
						projectVersionLink);
			} catch (HubNotificationServiceException | UnexpectedHubResponseException e) {
				logger.error(e);
				continue;
			}


			try {
				final HubEvents events = generateEvents(projectName, projectVersionName, projectVersionLink,
						componentName, componentVersionName, vulnerabilityNotificationContent,
						notifHubProjectReleaseItem);
				allEvents.addAllEvents(events);
			} catch (final HubNotificationServiceException e) {
				logger.error(e);
			}
		}

		return allEvents;
	}

	private HubEvents generateEvents(final String projectName, final String projectVersionName,
			final String projectVersionLink, final String componentName, final String componentVersionName,
			final VulnerabilityNotificationContent vulnerabilityNotificationContent,
			final ReleaseItem notifHubProjectReleaseItem) throws HubNotificationServiceException {
		final HubEvents notifResults = new HubEvents();

		String hubProjectUrl;
		try {
			hubProjectUrl = hubNotificationService.getProjectUrlFromProjectVersionUrl(projectVersionLink);
		} catch (HubNotificationServiceException | UnexpectedHubResponseException e) {
			final String msg = "Error getting project URL from project version URL: " + projectVersionLink + ": "
					+ e.getMessage();
			logger.error(msg);
			throw new HubNotificationServiceException(msg, e);
		}

		logger.debug("Getting JIRA project mapped to Hub project: " + projectName + " / " + projectVersionName);
		final List<JiraProject> mappingJiraProjects = mappings.getJiraProjects(hubProjectUrl);
		for (final JiraProject mappingJiraProject : mappingJiraProjects) {
			logger.debug("JIRA Project: " + mappingJiraProject);
			if (mappingJiraProject == null) {
				logger.info("Hub project " + projectName + " is not one of the configured/mapped projects; Skipping it");
				return notifResults;
			}

			final JiraProject jiraProject;
			try {
				jiraProject = getJiraProject(mappingJiraProject.getProjectId());
			} catch (final HubNotificationServiceException e) {
				logger.warn("Mapped project '" + mappingJiraProject.getProjectName() + "' with ID "
						+ mappingJiraProject.getProjectId() + " not found in JIRA; skipping this notification");
				continue;
			}

			final HubEvents oneProjectsResults = handleNotificationPerJiraProject(projectName,
					projectVersionName, notifHubProjectReleaseItem, componentName, componentVersionName,
					vulnerabilityNotificationContent,
					jiraProject);
			if (oneProjectsResults != null) {
				notifResults.addAllEvents(oneProjectsResults);
			}
		}


		return notifResults;
	}



	private HubEvents handleNotificationPerJiraProject(final String projectName,
			final String projectVersionName, final ReleaseItem notifHubProjectReleaseItem, final String componentName,
			final String componentVersionName, final VulnerabilityNotificationContent vulnerabilityNotificationContent,
			final JiraProject jiraProject) throws HubNotificationServiceException {

		final HubEvents notifResults = new HubEvents();

		final String componentVersionUrl = vulnerabilityNotificationContent.getComponentVersionLink();
		ComponentVersion componentVersion = null;

		try {
			componentVersion = hubNotificationService.getComponentVersion(componentVersionUrl);
		} catch (final HubNotificationServiceException e) {
			logger.error("Error getting componentVersion from URL: " + componentVersionUrl + ": " + e.getMessage());
			throw e;
		}


		UUID versionId;
		final UUID componentId;
		final UUID componentVersionId;
		final UUID ruleId;

		try {
			versionId = notifHubProjectReleaseItem.getVersionId();
		} catch (final MissingUUIDException e) {
			final String msg = "Error getting version ID from Project Release: " + notifHubProjectReleaseItem + ": "
					+ e.getMessage();
			logger.error(msg);
			throw new HubNotificationServiceException(msg, e);
		}

		try {
			componentId = componentVersion.getComponentId();
		} catch (final MissingUUIDException e) {
			final String msg = "Error getting component ID from component version: " + componentVersion + ": "
					+ e.getMessage();
			logger.error(msg);
			throw new HubNotificationServiceException(msg, e);
		}
		try {
			componentVersionId = componentVersion.getVersionId();
		} catch (final MissingUUIDException e) {
			final String msg = "Error getting component version ID from component version: " + componentVersion + ": "
					+ e.getMessage();
			logger.error(msg);
			throw new HubNotificationServiceException(msg, e);
		}

		// TODO: we'll have to do this for deletes and updates too
		// TODO: This generates one ticket per vuln, but that requirement may
		// change (different converter?)
		// maybe factor this bit out so the two converters share most of the
		// code
		final List<VulnerabilitySourceQualifiedId> vulns = vulnerabilityNotificationContent.getNewVulnerabilityIds();
		// for (final VulnerabilitySourceQualifiedId vuln : ) {
		final HubEventType eventType = HubEventType.VULNERABILITY_ADD;
		// final String vulnerableSource = vuln.getSource();
		// final String vulnerableId = vuln.getId();

		final HubEvent result = new VulnerabilityEvent(projectName,
				projectVersionName, componentName, componentVersionName, versionId, componentId,
				componentVersionId, getTicketGenInfo().getJiraUser().getName(), jiraProject.getIssueTypeId(),
 jiraProject.getProjectId(),
				jiraProject.getProjectName(), eventType, vulns);

		// TODO: too broad a bucket?
		notifResults.addVulnerabilityEvent(result);
		// }



		// if (result.getEventType() == EventType.POLICY_VIOLATION) {
		// notifResults.addPolicyViolationResult(result);
		// } else if (result.getEventType() == EventType.POLICY_OVERRIDE) {
		// notifResults.addPolicyViolationOverrideResult(result);
		// }

		return notifResults;
	}
}
